function store(e){dataCopy=JSON.parse(JSON.stringify(e)),dataCopy.list=e.list(),localStorage.mapData=JSON.stringify(dataCopy)}function initModel(){function e(e){return new GM.LatLng(e.G,e.K)}function t(e){var t=new GM.LatLng(e.Ia.G,e.Ca.j),a=new GM.LatLng(e.Ia.j,e.Ca.G);return new GM.LatLngBounds(t,a)}function a(a){return{location:e(a.location),viewport:t(a.viewport)}}var i;if(localStorage.mapData){i=JSON.parse(localStorage.mapData),i.centerData=a(i.centerData);for(var n=0;n<i.list.length;n++){var o=i.list[n];o.location=e(o.location)}i.list=ko.observableArray(i.list)}else i={placeName:PLACE_NAME,list:ko.observableArray()},store(i);return i}function ViewModel(){function e(e,i){a.selectedMarkers([]);var n=a.searchText().toLowerCase().split(" ").map(function(e){return e.replace(/s$/,"")});a.markers.forEach(function(o){if(t(n,o.getTitle()))return void a.selectedMarkers.push(o);for(var r=o.categories,s=0;r&&s<r.length;s++)if(t(n,r[s]))return void a.selectedMarkers.push(o);if(i===GM.places.PlacesServiceStatus.OK)for(var s=0;s<e.length;s++)if(e[s].place_id===o.place.placeId)return void a.selectedMarkers.push(o)}),a.loading(!1)}function t(e,t){t=t.toLowerCase();for(var a=0;a<e.length;a++)if(-1===t.indexOf(e[a]))return!1;return!0}var a=this;a.mapData=initModel(),a.searchText=ko.observable(""),a.hasQuery=ko.computed(function(){return a.searchText().length>0}),a.loading=ko.observable(!1),a.cantConnect=ko.observable(!1),a.alreadyFiltered=!1,a.markers=[],a.selectedMarkers=ko.observableArray(a.markers.slice(0)),a.selectedMarkers.subscribe(function(e){a.markers.forEach(function(e){a.searchText().length&&e.infoWindow.close(),e.setMap(null)}),e.forEach(function(e){e.setMap(MAP)})}),a.resultsList=[],a.currWindow=null,a.addPlace=function(e,t,i){var n=a.mapData.list,o=1;n().forEach(function(t){t.name===e&&o++}),a.mapData.list.push({name:e,num:o,place_id:t,location:i}),a.updateStorage()},a.removePlace=function(e){a.mapData.list.remove(function(t){return t.place_id===e}),a.updateStorage()},a.clearQuery=function(){a.searchText(""),a.filter(),a.clearResults()},a.clearResults=function(){a.resultsList.forEach(function(e){e.setMap(null)}),a.resultsList.length=0},a.onEnter=function(e,t){return 13===t.keyCode&&(a.alreadyFiltered=!0,setTimeout(function(){a.alreadyFiltered=!1},7e3),a.filter()),!0},a.filter=function(){if(!a.markers.length)return void(""===a.searchText()&&a.clearResults());if(""===a.searchText())a.clearResults(),a.selectedMarkers(a.markers);else{a.loading(!0),a.cantConnect(!1);var t=setTimeout(function(){a.cantConnect(!0),e(null,"bad")},5e3);PLACES.radarSearch({keyword:a.searchText(),bounds:a.mapData.centerData.viewport},function(a,i){clearTimeout(t),e(a,i)})}},a.pinned=function(e){for(var t=a.mapData.list(),i=0;i<t.length;i++)if(t[i].place_id===e)return!0;return!1},a.updateStorage=function(){store(a.mapData)}}function AJAXWindow(e,t,a){this.marker=e,this.viewModel=t,a?(this.parentList=a,this.isTemp=!0):this.isTemp=!1;var i=e.getTitle(),n=$('<div class="window-content">');n.append("<h3>"+i+"</h3>"),this.$leftNav=$('<div class="move-left">'),n.append(this.$leftNav),this.$rightNav=$('<div class="move-right">'),n.append(this.$rightNav);var o=$('<div class="loaded-content">');if(n.append(o),this.isTemp){var r=$('<div class="add-marker">');r.html("+ Add marker to map"),n.append(r)}this.infoWindow=new GM.InfoWindow,this.isNew=!0,this.loadedAPI=ko.observable();var s=setTimeout(function(){var e='<p class="pending"><i>No relevant information found.</i></p>';o.html(e),this.infoWindow.setContent(n[0])}.bind(this),3e3);this.loadedAPI.subscribe(function(e){var t;e?(clearTimeout(s),t=this.contentBlocks[e]):t='<p class="pending"><i>Place data loading...</i></p>',o.html(t),this.infoWindow.setContent(n[0]),this.isOpen()?this.addListeners():this.fresh=!0}.bind(this)),this.contentBlocks={streetview:null,foursquare:null,wiki:null},this.loadedAPI(null),this.fetchStreetView(),this.fetchFoursquare(),this.fetchWikipedia();var l=this;GM.event.addListener(e,"click",function(){AJAXWindow.windowSwap(l)})}var PLACE_NAME="San Francisco, California",GM=google.maps,MAP=new GM.Map(document.getElementById("map-canvas")),PANO=MAP.getStreetView(),PLACES=new GM.places.PlacesService(MAP),STREET_VIEW=new google.maps.StreetViewService,ZOOM=10;ko.bindingHandlers.map={init:function(e,t,a,i,n){function o(e,t){t===GM.places.PlacesServiceStatus.OK&&(s.centerData=e[0].geometry,l.updateStorage(),MAP.setOptions({center:s.centerData.location,zoom:ZOOM,disableDefaultUI:!0}),r(),$("#headline").show(),$("#pac-input").show(),$("#sidebar").show())}function r(){var e=document.getElementById("pac-input");window.searchBox=new GM.places.SearchBox(e),MAP.controls[GM.ControlPosition.TOP_LEFT].push(e),searchBox.setBounds(s.centerData.viewport),$("#pac-input").click(function(e){e.stopPropagation()}),$("#map-canvas").click(function(){$("#pac-input").blur()});var t=l.resultsList;searchBox.addListener("places_changed",function(){l.alreadyFiltered?l.alreadyFiltered=!1:l.filter();var e=searchBox.getPlaces();0!==e.length&&(l.clearResults(),l.currWindow&&l.currWindow.close(),e.forEach(function(e){if(!l.pinned(e.place_id)){var a={url:e.icon,anchor:new GM.Point(17,34),scaledSize:new GM.Size(25,25)},i=new GM.Marker({map:MAP,icon:a,title:e.name,place:{location:e.geometry.location,placeId:e.place_id}});i.infoWindow=new AJAXWindow(i,l,t),t.push(i)}}))})}var s=t(),l=n.$data;s.centerData?(MAP.setOptions({center:s.centerData.location,zoom:ZOOM,disableDefaultUI:!0}),r(),$("#headline").show(),$("#pac-input").show(),$("#sidebar").show()):PLACES.textSearch({query:s.placeName},o)},update:function(e,t,a,i,n){var o=t().list(),r=n.$data,s=r.markers;if(o.length>s.length)for(var l=s.length;l<o.length;l++){var c=o[l],d=new GM.Marker({icon:"images/marker.png",title:c.name,place:{location:c.location,placeId:c.place_id}});d.infoWindow=new AJAXWindow(d,r),d.data=c,s.push(d),r.selectedMarkers.push(d)}else if(o.length<s.length)for(var l=0;l<s.length;l++){var c=o[l],d=s[l];if(!c||c.place_id!==d.getPlace().placeId)return d.setMap(null),s.splice(l,1),void r.selectedMarkers.remove(d)}}},AJAXWindow.prototype.open=function(){this.infoWindow.open(MAP,this.marker)},AJAXWindow.prototype.close=function(){this.infoWindow.close()},AJAXWindow.prototype.isOpen=function(){var e=this.infoWindow.getMap();return null!==e&&"undefined"!=typeof e},AJAXWindow.prototype.launch=function(){this.open(),this.viewModel.currWindow=this,this.fresh&&(this.addListeners(),this.fresh=!1)},AJAXWindow.prototype.moveLeft=function(){this.move(-1)},AJAXWindow.prototype.moveRight=function(){this.move(1)},AJAXWindow.prototype.move=function(e){var t=this.getLoadedKeys(),a=t.indexOf(this.loadedAPI()),i=a+e;i>=t.length?i-=t.length:0>i&&(i+=t.length),this.loadedAPI(t[i])},AJAXWindow.prototype.getLoadedKeys=function(){var e=[];for(var t in this.contentBlocks)this.contentBlocks[t]&&e.push(t);return e},AJAXWindow.prototype.launchStreetView=function(){var e=this.marker.place.location;PANO.setVisible(!0),PANO.setPosition(e),PANO.setPov({heading:270,pitch:0})},AJAXWindow.prototype.checkNavigation=function(){this.getLoadedKeys().length>=2?(this.$leftNav.css("display","initial"),this.$rightNav.css("display","initial")):(this.$leftNav.css("display","none"),this.$rightNav.css("display","none"))},AJAXWindow.prototype.addListeners=function(){var e=this.marker,t=this.viewModel,a=e.getPlace(),i=e.getTitle(),n=a.placeId,o=a.location,r=this;if(this.isNew&&($(".gm-style-iw").mouseenter(function(){MAP.setOptions({draggable:!1,scrollwheel:!1})}),$(".gm-style-iw").mouseleave(function(){MAP.setOptions({draggable:!0,scrollwheel:!0})}),this.isNew=!1),this.isTemp===!0){var s=this.parentList,l=$._data($(".add-marker:last")[0],"events");l||$(".add-marker:last").click(function(){t.addPlace(i,n,o),e.setMap(null),s.splice(s.indexOf(e),1),MAP.setOptions({draggable:!0,scrollwheel:!0})})}var c=$._data(this.$leftNav[0],"events");c||(this.$leftNav.click(function(){r.moveLeft()}),this.$rightNav.click(function(){r.moveRight()}));var d=this.loadedAPI();if(d&&"streetview"===d){var p=$._data($(".streetview:last")[0],"events");p||$(".streetview:last").click(function(){r.launchStreetView()})}},AJAXWindow.prototype.fetchStreetView=function(){function e(e,t){t===GM.StreetViewStatus.OK&&(o.contentBlocks.streetview='<div class="streetview"><img title="Google Street View"src="https://maps.googleapis.com/maps/api/streetview?size=300x130&location='+i+","+n+'"></div>',o.loadedAPI("streetview"),o.checkNavigation())}var t=this.marker,a=t.getPlace().location,i=a.lat(),n=a.lng(),o=this;STREET_VIEW.getPanorama({location:a,radius:50},e)},AJAXWindow.prototype.fetchFoursquare=function(){function e(e){if(0!==e.response.venues.length){var a=e.response.venues[0],i=$('<div class="foursquare">');i.append('<div class="content-title">Place details (from Foursquare)</div>'),$info=$('<div class="foursquare-info">'),i.append($info);var n=a.categories;if(n.length>0&&n[0].name){var o="<i>"+n[0].name+"</i>";$info.append(o),t.categories=n.map(function(e){return e.name})}if((a.hasMenu||a.url)&&$info.append("<br>"),a.hasMenu){var s=a.menu.mobileUrl,l='<a href="'+s+'" target="_blank">View menu</a>';$info.append(l)}if(a.hasMenu&&a.url&&$info.append(" | "),a.url){var c='<a href="'+a.url+'" target="_blank">Visit website</a>';$info.append(c)}var d=a.location;if(d.formattedAddress){var p="<p><strong>Address:</strong><br>"+d.formattedAddress[0]+"<br>"+d.formattedAddress[1]+"</p>";$info.append(p)}var u=a.contact;if(u.formattedPhone){var h="tel:+"+u.phone,f='<p><strong>Phone:</strong> <a href="'+h+'" target="_blank">'+u.formattedPhone+"</a></p>";$info.append(f)}if(u.twitter){var v="https://twitter.com/"+u.twitter,w='<p><strong>Twitter:</strong> <a href="'+v+'" target="_blank">@'+u.twitter+"</a></p>";$info.append(w)}var g="https://foursquare.com/v/"+a.id,m='For more info, check out <a href="'+g+'" target="_blank">'+a.name+" on Foursquare</a>.";$info.append("<p>"+m+"</p>"),r.contentBlocks.foursquare=i[0].outerHTML,r.checkNavigation()}}var t=this.marker,a=t.getTitle(),i=t.getPlace().location,n=i.lat(),o=i.lng(),r=this,s="https://api.foursquare.com/v2/venues/search?ll="+n+","+o+"&query="+a+"&client_id=MT2PAXNGUMMPXXGT05EJMHE2B2BEOWDLLLMDIHFYTRXE3DRD&client_secret=IBE2CFQIOMN4Q0ARJL14BUIVX1T0UOEDLFDNQY412LNMKLWR&v=20150822";$.getJSON(s,e)},AJAXWindow.prototype.fetchWikipedia=function(){function e(e){if(0!==e[1].length){var t=e[1],i=e[3],n=$('<div class="wiki">');n.append('<div class="content-title">Wikipedia Results</div>'),$list=$('<div class="wiki-list">'),n.append($list);for(var o=0;o<i.length;o++){var r=t[o],s=i[o];$entry=$("<div>"),$entry.append('<a href="'+s+'" target="_blank">'+r+"</a>"),$list.append($entry)}a.contentBlocks.wiki=n[0].outerHTML,a.checkNavigation()}}var t=this.marker.getTitle(),a=this;$.ajax({url:"https://en.wikipedia.org/w/api.php?action=opensearch&search="+t+"&format=json&callback=wikiCallback",dataType:"jsonp",success:e})},AJAXWindow.windowSwap=function(e){var t=e.viewModel;t.currWindow&&t.currWindow.isOpen()?(t.currWindow.close(),e!==t.currWindow&&e.launch()):e.launch()},AJAXWindow.hideStreetView=function(){PANO.setVisible(!1)};var viewModel=new ViewModel;ko.applyBindings(viewModel);