function store(e){var t=JSON.parse(JSON.stringify(e));t.list=e.list(),localStorage.mapData=JSON.stringify(t)}function initModel(){function e(e){return new GM.LatLng(e.G,e.K)}function t(e){var t=new GM.LatLng(e.Ia.G,e.Ca.j),a=new GM.LatLng(e.Ia.j,e.Ca.G);return new GM.LatLngBounds(t,a)}function a(a){return{location:e(a.location),viewport:t(a.viewport)}}var i;if(localStorage.mapData){i=JSON.parse(localStorage.mapData),i.centerData=a(i.centerData);for(var n=0;n<i.list.length;n++){var r=i.list[n];r.location=e(r.location)}i.list=ko.observableArray(i.list)}else i={placeName:PLACE_NAME,list:ko.observableArray()},store(i);return i}function ViewModel(){function e(e,i){a.selectedMarkers([]);var n=a.searchText().toLowerCase().split(" ").map(function(e){return e.replace(/s$/,"")});a.markers.forEach(function(r){if(t(n,r.getTitle()))return void a.selectedMarkers.push(r);for(var o=r.categories,s=0;o&&s<o.length;s++)if(t(n,o[s]))return void a.selectedMarkers.push(r);if(i===GM.places.PlacesServiceStatus.OK)for(var s=0;s<e.length;s++)if(e[s].place_id===r.place.placeId)return void a.selectedMarkers.push(r)}),a.loading(!1)}function t(e,t){t=t.toLowerCase();for(var a=0;a<e.length;a++)if(-1===t.indexOf(e[a]))return!1;return!0}var a=this;a.mapData=initModel(),a.searchText=ko.observable(""),a.hasQuery=ko.computed(function(){return a.searchText().length>0}),a.listShowing=ko.observable(!1),a.loading=ko.observable(!1),a.cantConnect=ko.observable(!1),a.alreadyFiltered=!1,a.markers=[],a.selectedMarkers=ko.observableArray(a.markers.slice(0)),a.selectedMarkers.subscribe(function(e){a.markers.forEach(function(e){a.searchText().length&&e.infoWindow.close(),e.setMap(null)}),e.forEach(function(e){e.setMap(MAP)})}),a.resultsList=[],a.currWindow=null,a.addPlace=function(e,t,i){var n=a.mapData.list,r=1;n().forEach(function(t){t.name===e&&r++}),a.mapData.list.push({name:e,num:r,place_id:t,location:i}),a.updateStorage()},a.removePlace=function(e){a.mapData.list.remove(function(t){return t.place_id===e}),a.updateStorage()},a.clearQuery=function(){a.searchText(""),a.filter(),a.clearResults()},a.clearResults=function(){a.resultsList.forEach(function(e){e.setMap(null)}),a.resultsList.length=0},a.onEnter=function(e,t){return 13===t.keyCode&&(a.alreadyFiltered=!0,setTimeout(function(){a.alreadyFiltered=!1},7e3),a.filter()),!0},a.filter=function(){if(!a.markers.length)return void(""===a.searchText()&&a.clearResults());if(""===a.searchText())a.clearResults(),a.selectedMarkers(a.markers);else{a.loading(!0),a.cantConnect(!1);var t=setTimeout(function(){a.cantConnect(!0),e(null,"bad")},5e3);PLACES.radarSearch({keyword:a.searchText(),bounds:a.mapData.centerData.viewport},function(a,i){clearTimeout(t),e(a,i)})}},a.pinned=function(e){for(var t=a.mapData.list(),i=0;i<t.length;i++)if(t[i].place_id===e)return!0;return!1},a.toggleListDisplay=function(){a.listShowing(!a.listShowing())},a.updateStorage=function(){store(a.mapData)}}function AJAXWindow(e,t,a){this.marker=e,this.viewModel=t,a?(this.parentList=a,this.isTemp=!0):this.isTemp=!1;var i=e.getTitle(),n=$('<div class="window-content">');n.append("<h3>"+i+"</h3>"),this.$leftNav=$('<div class="move-left">'),n.append(this.$leftNav),this.$rightNav=$('<div class="move-right">'),n.append(this.$rightNav);var r=$('<div class="loaded-content">');if(n.append(r),this.isTemp){var o=$('<div class="add-marker">');o.html("+ Add marker to map"),n.append(o)}this.infoWindow=new GM.InfoWindow,this.isNew=!0,this.loadedAPI=ko.observable();var s=setTimeout(function(){var e='<p class="pending"><i>No relevant information found.</i></p>';r.html(e),this.infoWindow.setContent(n[0])}.bind(this),3e3);this.loadedAPI.subscribe(function(e){var t;e?(clearTimeout(s),t=this.contentBlocks[e]):t='<p class="pending"><i>Place data loading...</i></p>',r.html(t),this.infoWindow.setContent(n[0]),this.isOpen()?this.addListeners():this.fresh=!0}.bind(this)),this.contentBlocks={streetview:null,foursquare:null,wiki:null},this.loadedAPI(null),this.fetchStreetView(),this.fetchFoursquare(),this.fetchWikipedia();var l=this;GM.event.addListener(e,"click",function(){AJAXWindow.windowSwap(l)})}var PLACE_NAME="San Francisco, California",GM=google.maps,MAP=new GM.Map(document.getElementById("map-canvas")),PANO=MAP.getStreetView(),PLACES=new GM.places.PlacesService(MAP),STREET_VIEW=new google.maps.StreetViewService,ZOOM=10;ko.bindingHandlers.map={init:function(e,t,a,i,n){function r(e,t){t===GM.places.PlacesServiceStatus.OK&&(s.centerData=e[0].geometry,l.updateStorage(),MAP.setOptions({center:s.centerData.location,zoom:ZOOM,disableDefaultUI:!0}),o(),$("#pac-input").show())}function o(){var e=document.getElementById("pac-input"),t=new GM.places.SearchBox(e);MAP.controls[GM.ControlPosition.TOP_LEFT].push(e),t.setBounds(s.centerData.viewport),$("#pac-input").click(function(e){e.stopPropagation()}),$("#map-canvas").click(function(){$("#pac-input").blur()});var a=l.resultsList;t.addListener("places_changed",function(){l.alreadyFiltered?l.alreadyFiltered=!1:l.filter();var e=t.getPlaces();0!==e.length&&(l.clearResults(),l.currWindow&&l.currWindow.close(),e.forEach(function(e){if(!l.pinned(e.place_id)){var t={url:e.icon,anchor:new GM.Point(17,34),scaledSize:new GM.Size(25,25)},i=new GM.Marker({map:MAP,icon:t,title:e.name,place:{location:e.geometry.location,placeId:e.place_id}});i.infoWindow=new AJAXWindow(i,l,a),a.push(i)}}))})}var s=t(),l=n.$data;s.centerData?(MAP.setOptions({center:s.centerData.location,zoom:ZOOM,disableDefaultUI:!0}),o(),$("#pac-input").show()):PLACES.textSearch({query:s.placeName},r)},update:function(e,t,a,i,n){var r=t().list(),o=n.$data,s=o.markers;if(r.length>s.length)for(var l=s.length;l<r.length;l++){var c=r[l],d=new GM.Marker({icon:"images/marker.png",title:c.name,place:{location:c.location,placeId:c.place_id}});d.infoWindow=new AJAXWindow(d,o),d.data=c,s.push(d),o.selectedMarkers.push(d)}else if(r.length<s.length)for(var l=0;l<s.length;l++){var c=r[l],d=s[l];if(!c||c.place_id!==d.getPlace().placeId)return d.setMap(null),s.splice(l,1),void o.selectedMarkers.remove(d)}}},AJAXWindow.prototype.open=function(){this.infoWindow.open(MAP,this.marker)},AJAXWindow.prototype.close=function(){this.infoWindow.close()},AJAXWindow.prototype.isOpen=function(){var e=this.infoWindow.getMap();return null!==e&&"undefined"!=typeof e},AJAXWindow.prototype.launch=function(){this.open(),this.viewModel.currWindow=this,this.fresh&&(this.addListeners(),this.fresh=!1)},AJAXWindow.prototype.moveLeft=function(){this.move(-1)},AJAXWindow.prototype.moveRight=function(){this.move(1)},AJAXWindow.prototype.move=function(e){var t=this.getLoadedKeys(),a=t.indexOf(this.loadedAPI()),i=a+e;i>=t.length?i-=t.length:0>i&&(i+=t.length),this.loadedAPI(t[i])},AJAXWindow.prototype.getLoadedKeys=function(){var e=[];for(var t in this.contentBlocks)this.contentBlocks[t]&&e.push(t);return e},AJAXWindow.prototype.launchStreetView=function(){var e=this.marker.place.location;PANO.setVisible(!0),PANO.setPosition(e),PANO.setPov({heading:270,pitch:0})},AJAXWindow.prototype.checkNavigation=function(){this.getLoadedKeys().length>=2?(this.$leftNav.css("display","initial"),this.$rightNav.css("display","initial")):(this.$leftNav.css("display","none"),this.$rightNav.css("display","none"))},AJAXWindow.prototype.addListeners=function(){var e=this.marker,t=this.viewModel,a=e.getPlace(),i=e.getTitle(),n=a.placeId,r=a.location,o=this;if(this.isNew&&($(".gm-style-iw").mouseenter(function(){MAP.setOptions({draggable:!1,scrollwheel:!1})}),$(".gm-style-iw").mouseleave(function(){MAP.setOptions({draggable:!0,scrollwheel:!0})}),this.isNew=!1),this.isTemp===!0){var s=this.parentList,l=$._data($(".add-marker:last")[0],"events");l||$(".add-marker:last").click(function(){t.addPlace(i,n,r),e.setMap(null),s.splice(s.indexOf(e),1),MAP.setOptions({draggable:!0,scrollwheel:!0})})}var c=$._data(this.$leftNav[0],"events");c||(this.$leftNav.click(function(){o.moveLeft()}),this.$rightNav.click(function(){o.moveRight()}));var d=this.loadedAPI();if(d&&"streetview"===d){var p=$._data($(".streetview:last")[0],"events");p||$(".streetview:last").click(function(){o.launchStreetView()})}},AJAXWindow.prototype.fetchStreetView=function(){function e(e,t){t===GM.StreetViewStatus.OK&&(r.contentBlocks.streetview='<div class="streetview"><img title="Google Street View"src="https://maps.googleapis.com/maps/api/streetview?size=300x130&location='+i+","+n+'"></div>',r.loadedAPI("streetview"),r.checkNavigation())}var t=this.marker,a=t.getPlace().location,i=a.lat(),n=a.lng(),r=this;STREET_VIEW.getPanorama({location:a,radius:50},e)},AJAXWindow.prototype.fetchFoursquare=function(){function e(e){if(0!==e.response.venues.length){var a=e.response.venues[0],i=$('<div class="foursquare">');i.append('<div class="content-title">Place details (from Foursquare)</div>');var n=$('<div class="foursquare-info">');i.append(n);var r=a.categories;if(r.length>0&&r[0].name){var s="<i>"+r[0].name+"</i>";n.append(s),t.categories=r.map(function(e){return e.name})}if((a.hasMenu||a.url)&&n.append("<br>"),a.hasMenu){var l=a.menu.mobileUrl,c='<a href="'+l+'" target="_blank">View menu</a>';n.append(c)}if(a.hasMenu&&a.url&&n.append(" | "),a.url){var d='<a href="'+a.url+'" target="_blank">Visit website</a>';n.append(d)}var p=a.location;if(p.formattedAddress){var u="<p><strong>Address:</strong><br>"+p.formattedAddress[0]+"<br>"+p.formattedAddress[1]+"</p>";n.append(u)}var h=a.contact;if(h.formattedPhone){var f="tel:+"+h.phone,v='<p><strong>Phone:</strong> <a href="'+f+'" target="_blank">'+h.formattedPhone+"</a></p>";n.append(v)}if(h.twitter){var g="https://twitter.com/"+h.twitter,w='<p><strong>Twitter:</strong> <a href="'+g+'" target="_blank">@'+h.twitter+"</a></p>";n.append(w)}var m="https://foursquare.com/v/"+a.id,A='For more info, check out <a href="'+m+'" target="_blank">'+a.name+" on Foursquare</a>.";n.append("<p>"+A+"</p>"),o.contentBlocks.foursquare=i[0].outerHTML,o.checkNavigation()}}var t=this.marker,a=t.getTitle(),i=t.getPlace().location,n=i.lat(),r=i.lng(),o=this,s="https://api.foursquare.com/v2/venues/search?ll="+n+","+r+"&query="+a+"&client_id=MT2PAXNGUMMPXXGT05EJMHE2B2BEOWDLLLMDIHFYTRXE3DRD&client_secret=IBE2CFQIOMN4Q0ARJL14BUIVX1T0UOEDLFDNQY412LNMKLWR&v=20150822";$.getJSON(s,e)},AJAXWindow.prototype.fetchWikipedia=function(){function e(e){if(0!==e[1].length){var t=e[1],i=e[3],n=$('<div class="wiki">');n.append('<div class="content-title">Wikipedia Results</div>');var r=$('<div class="wiki-list">');n.append(r);for(var o=0;o<i.length;o++){var s=t[o],l=i[o],c=$("<div>");c.append('<a href="'+l+'" target="_blank">'+s+"</a>"),r.append(c)}a.contentBlocks.wiki=n[0].outerHTML,a.checkNavigation()}}var t=this.marker.getTitle(),a=this;$.ajax({url:"https://en.wikipedia.org/w/api.php?action=opensearch&search="+t+"&format=json&callback=wikiCallback",dataType:"jsonp",success:e})},AJAXWindow.windowSwap=function(e){var t=e.viewModel;t.currWindow&&t.currWindow.isOpen()?(t.currWindow.close(),e!==t.currWindow&&e.launch()):e.launch()},AJAXWindow.hideStreetView=function(){PANO.setVisible(!1)};var viewModel=new ViewModel;ko.applyBindings(viewModel);