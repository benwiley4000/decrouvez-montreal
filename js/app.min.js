function store(e){var t=JSON.parse(JSON.stringify(e));t.list=e.list(),localStorage.mapData=JSON.stringify(t)}function initModel(){function e(e){return new GM.LatLng(e.G,e.K)}function t(e){var t=new GM.LatLng(e.Ia.G,e.Ca.j),i=new GM.LatLng(e.Ia.j,e.Ca.G);return new GM.LatLngBounds(t,i)}function i(i){return{location:e(i.location),viewport:t(i.viewport)}}var a;if(localStorage.mapData){a=JSON.parse(localStorage.mapData),a.centerData=i(a.centerData);for(var n=0,o=a.list.length;o>n;n++){var r=a.list[n];r.location=e(r.location)}a.list=ko.observableArray(a.list)}else a={placeName:PLACE_NAME,list:ko.observableArray()},store(a);return a}function ViewModel(){function e(e,t){t=t.toLowerCase();for(var i=0,a=e.length;a>i;i++)if(-1===t.indexOf(e[i]))return!1;return!0}var t=this;t.mapData=initModel(),t.searchText=ko.observable(""),t.hasQuery=ko.computed(function(){return t.searchText().length>0}),t.listShowing=ko.observable(!1),t.markers=[],t.selectedMarkers=ko.observableArray(t.markers.slice(0)),t.selectedMarkers.subscribe(function(e){t.markers.forEach(function(e){t.searchText().length&&e.infoWindow.close(),e.setMap(null)}),e.forEach(function(e){e.setMap(MAP)})}),t.resultsList=[],t.currWindow=null,t.addPlace=function(e,i,a){var n=t.mapData.list,o=1;n().forEach(function(t){t.name===e&&o++}),t.mapData.list.push({name:e,num:o,place_id:i,location:a}),t.updateStorage()},t.removePlace=function(e){t.mapData.list.remove(function(t){return t.place_id===e}),t.updateStorage()},t.clearQuery=function(){t.searchText(""),t.filter(),t.clearResults()},t.clearResults=function(){t.resultsList.forEach(function(e){e.setMap(null)}),t.resultsList.length=0},t.onEnter=function(e,i){return 13===i.keyCode&&(t.alreadyFiltered=!0,setTimeout(function(){t.alreadyFiltered=!1},7e3),t.filter()),!0},t.filter=function(){if(t.markers.length)if(""===t.searchText())t.clearResults(),t.selectedMarkers(t.markers);else{t.selectedMarkers([]);var i=t.searchText().toLowerCase().split(" ").map(function(e){return e.replace(/s$/,"")});t.markers.forEach(function(a){if(e(i,a.getTitle()))return void t.selectedMarkers.push(a);var n=a.categories;if(n)for(var o=0,r=n.length;r>o;o++)if(e(i,n[o]))return void t.selectedMarkers.push(a)})}else""===t.searchText()&&t.clearResults()},t.pinned=function(e){for(var i=t.mapData.list(),a=0,n=i.length;n>a;a++)if(i[a].place_id===e)return!0;return!1},t.toggleListDisplay=function(){t.listShowing(!t.listShowing())},t.updateStorage=function(){store(t.mapData)}}function AJAXWindow(e,t,i){this.marker=e,this.viewModel=t,i?(this.parentList=i,this.isTemp=!0):this.isTemp=!1;var a=e.getTitle(),n=$('<div class="window-content">');n.append("<h3>"+a+"</h3>"),this.$leftNav=$('<div class="move-left">'),n.append(this.$leftNav),this.$rightNav=$('<div class="move-right">'),n.append(this.$rightNav);var o=$('<div class="loaded-content">');if(n.append(o),this.isTemp){var r=$('<div class="add-marker">');r.html("+ Add marker to map"),n.append(r)}this.infoWindow=new GM.InfoWindow,this.isNew=!0,this.loadedAPI=ko.observable();var s=setTimeout(function(){var e='<p class="pending"><i>No relevant information found.</i></p>';o.html(e),this.infoWindow.setContent(n[0])}.bind(this),3e3);this.loadedAPI.subscribe(function(e){var t;e?(clearTimeout(s),t=this.contentBlocks[e]):t='<p class="pending"><i>Place data loading...</i></p>',o.html(t),this.infoWindow.setContent(n[0]),this.isOpen()?this.addListeners():this.fresh=!0}.bind(this)),this.contentBlocks={streetview:null,foursquare:null,wiki:null},this.loadedAPI(null),this.fetchStreetView(),this.fetchFoursquare(),this.fetchWikipedia();var l=this;GM.event.addListener(e,"click",function(){AJAXWindow.windowSwap(l)})}var PLACE_NAME="San Francisco, California",GM=google.maps,MAP=new GM.Map(document.getElementById("map-canvas")),PANO=MAP.getStreetView(),PLACES=new GM.places.PlacesService(MAP),STREET_VIEW=new google.maps.StreetViewService,ZOOM=10;ko.bindingHandlers.map={init:function(e,t,i,a,n){function o(e,t){t===GM.places.PlacesServiceStatus.OK&&(s.centerData=e[0].geometry,l.updateStorage(),MAP.setOptions({center:s.centerData.location,zoom:ZOOM,disableDefaultUI:!0}),r(),$("#pac-input").show())}function r(){var e=document.getElementById("pac-input"),t=new GM.places.SearchBox(e);MAP.controls[GM.ControlPosition.TOP_LEFT].push(e),t.setBounds(s.centerData.viewport),$("#pac-input").click(function(e){e.stopPropagation()}),$("#map-canvas").click(function(){$("#pac-input").blur()});var i=l.resultsList;t.addListener("places_changed",function(){var e=t.getPlaces();0!==e.length&&(l.clearResults(),l.currWindow&&l.currWindow.close(),e.forEach(function(e){if(!l.pinned(e.place_id)){var t={url:e.icon,anchor:new GM.Point(17,34),scaledSize:new GM.Size(25,25)},a=new GM.Marker({map:MAP,icon:t,title:e.name,place:{location:e.geometry.location,placeId:e.place_id}});a.infoWindow=new AJAXWindow(a,l,i),i.push(a)}}))})}var s=t(),l=n.$data;PANO.addListener("visible_changed",function(){PANO.getVisible()?$("#sidebar-container").hide():$("#sidebar-container").show()}),s.centerData?(MAP.setOptions({center:s.centerData.location,zoom:ZOOM,disableDefaultUI:!0}),r(),$("#pac-input").show()):PLACES.textSearch({query:s.placeName},o)},update:function(e,t,i,a,n){var o=t().list(),r=n.$data,s=r.markers;if(o.length>s.length)for(var l=s.length,c=o.length;c>l;l++){var d=o[l],p=new GM.Marker({icon:"images/marker.png",title:d.name,place:{location:d.location,placeId:d.place_id}});p.infoWindow=new AJAXWindow(p,r),p.data=d,s.push(p),r.selectedMarkers.push(p)}else if(o.length<s.length)for(var l=0,c=s.length;c>l;l++){var d=o[l],p=s[l];if(!d||d.place_id!==p.getPlace().placeId)return p.setMap(null),s.splice(l,1),void r.selectedMarkers.remove(p)}}},AJAXWindow.prototype.open=function(){var e=this.marker;this.infoWindow.open(MAP,e),e.setAnimation(GM.Animation.BOUNCE),setTimeout(function(){e.setAnimation(null)},1400)},AJAXWindow.prototype.close=function(){this.infoWindow.close()},AJAXWindow.prototype.isOpen=function(){var e=this.infoWindow.getMap();return null!==e&&"undefined"!=typeof e},AJAXWindow.prototype.launch=function(){this.open(),this.viewModel.currWindow=this,this.fresh&&(this.addListeners(),this.fresh=!1)},AJAXWindow.prototype.moveLeft=function(){this.move(-1)},AJAXWindow.prototype.moveRight=function(){this.move(1)},AJAXWindow.prototype.move=function(e){var t=this.getLoadedKeys(),i=t.indexOf(this.loadedAPI()),a=i+e;a>=t.length?a-=t.length:0>a&&(a+=t.length),this.loadedAPI(t[a])},AJAXWindow.prototype.getLoadedKeys=function(){var e=[];for(var t in this.contentBlocks)this.contentBlocks[t]&&e.push(t);return e},AJAXWindow.prototype.launchStreetView=function(){var e=this.marker.place.location;PANO.setVisible(!0),PANO.setPosition(e),PANO.setPov({heading:270,pitch:0})},AJAXWindow.prototype.checkNavigation=function(){this.getLoadedKeys().length>=2?(this.$leftNav.css("display","initial"),this.$rightNav.css("display","initial")):(this.$leftNav.css("display","none"),this.$rightNav.css("display","none"))},AJAXWindow.prototype.addListeners=function(){var e=this.marker,t=this.viewModel,i=e.getPlace(),a=e.getTitle(),n=i.placeId,o=i.location,r=this;if(this.isNew&&($(".gm-style-iw").mouseenter(function(){MAP.setOptions({draggable:!1,scrollwheel:!1})}),$(".gm-style-iw").mouseleave(function(){MAP.setOptions({draggable:!0,scrollwheel:!0})}),this.isNew=!1),this.isTemp===!0){var s=this.parentList,l=$._data($(".add-marker:last")[0],"events");l||$(".add-marker:last").click(function(){t.addPlace(a,n,o),e.setMap(null),s.splice(s.indexOf(e),1),MAP.setOptions({draggable:!0,scrollwheel:!0})})}var c=$._data(this.$leftNav[0],"events");c||(this.$leftNav.click(function(){r.moveLeft()}),this.$rightNav.click(function(){r.moveRight()}));var d=this.loadedAPI();if(d&&"streetview"===d){var p=$._data($(".streetview:last")[0],"events");p||$(".streetview:last").click(function(){r.launchStreetView()})}},AJAXWindow.prototype.fetchStreetView=function(){function e(e,t){t===GM.StreetViewStatus.OK&&(o.contentBlocks.streetview='<div class="streetview"><img title="Google Street View"src="https://maps.googleapis.com/maps/api/streetview?size=300x130&location='+a+","+n+'"></div>',o.loadedAPI("streetview"),o.checkNavigation())}var t=this.marker,i=t.getPlace().location,a=i.lat(),n=i.lng(),o=this;STREET_VIEW.getPanorama({location:i,radius:50},e)},AJAXWindow.prototype.fetchFoursquare=function(){function e(e){if(0!==e.response.venues.length){var i=e.response.venues[0],a=$('<div class="foursquare">');a.append('<div class="content-title">Place details (from Foursquare)</div>');var n=$('<div class="foursquare-info">');a.append(n);var o=i.categories;if(o.length>0&&o[0].name){var s="<i>"+o[0].name+"</i>";n.append(s),t.categories=o.map(function(e){return e.name})}if((i.hasMenu||i.url)&&n.append("<br>"),i.hasMenu){var l=i.menu.mobileUrl,c='<a href="'+l+'" target="_blank">View menu</a>';n.append(c)}if(i.hasMenu&&i.url&&n.append(" | "),i.url){var d='<a href="'+i.url+'" target="_blank">Visit website</a>';n.append(d)}var p=i.location;if(p.formattedAddress){var u="<p><strong>Address:</strong><br>"+p.formattedAddress[0]+"<br>"+p.formattedAddress[1]+"</p>";n.append(u)}var h=i.contact;if(h.formattedPhone){var f="tel:+"+h.phone,v='<p><strong>Phone:</strong> <a href="'+f+'" target="_blank">'+h.formattedPhone+"</a></p>";n.append(v)}if(h.twitter){var g="https://twitter.com/"+h.twitter,w='<p><strong>Twitter:</strong> <a href="'+g+'" target="_blank">@'+h.twitter+"</a></p>";n.append(w)}var m="https://foursquare.com/v/"+i.id,A='For more info, check out <a href="'+m+'" target="_blank">'+i.name+" on Foursquare</a>.";n.append("<p>"+A+"</p>"),r.contentBlocks.foursquare=a[0].outerHTML,r.checkNavigation()}}var t=this.marker,i=t.getTitle(),a=t.getPlace().location,n=a.lat(),o=a.lng(),r=this,s="https://api.foursquare.com/v2/venues/search?ll="+n+","+o+"&query="+i+"&client_id=MT2PAXNGUMMPXXGT05EJMHE2B2BEOWDLLLMDIHFYTRXE3DRD&client_secret=IBE2CFQIOMN4Q0ARJL14BUIVX1T0UOEDLFDNQY412LNMKLWR&v=20150822";$.getJSON(s,e)},AJAXWindow.prototype.fetchWikipedia=function(){function e(e){if(0!==e[1].length){var t=e[1],a=e[3],n=$('<div class="wiki">');n.append('<div class="content-title">Wikipedia Results</div>');var o=$('<div class="wiki-list">');n.append(o);for(var r=0,s=a.length;s>r;r++){var l=t[r],c=a[r],d=$("<div>");d.append('<a href="'+c+'" target="_blank">'+l+"</a>"),o.append(d)}i.contentBlocks.wiki=n[0].outerHTML,i.checkNavigation()}}var t=this.marker.getTitle(),i=this;$.ajax({url:"https://en.wikipedia.org/w/api.php?action=opensearch&search="+t+"&format=json&callback=wikiCallback",dataType:"jsonp",success:e})},AJAXWindow.windowSwap=function(e){var t=e.viewModel;t.currWindow&&t.currWindow.isOpen()?(t.currWindow.close(),e!==t.currWindow&&e.launch()):e.launch()},AJAXWindow.hideStreetView=function(){PANO.setVisible(!1)};var viewModel=new ViewModel;ko.applyBindings(viewModel);